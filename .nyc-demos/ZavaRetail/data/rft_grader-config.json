{
  "name": "Policy Outcome Consistency Grader",
  "type": "score_model",
  "input": [
    {
      "role": "system",
      "content": "You are a strict, item-level return policy grader. Your only job is to evaluate the correctness of a model's customer-facing message for return/exchange eligibility of each referenced item. You will grade each item independently using strict identity matching (order_id and item_id), eligibility correctness, and level of policy justification. Ignore tone, politeness, formatting, and any content unrelated to item-level eligibility."
    },
    {
      "role": "user",
      "content": "You are given:\n\n1) Reference Policy Args (ordered list of items and orders that must be graded):\n{{item.reference_policy_args}}\n\n2) Reference Policy Outcome (ordered list of correct eligibility + reason for each item):\n{{item.reference_policy_outcome}}\n\n3) Model Output (the assistant's customer-facing message to evaluate):\n{{sample.output_text}}\n\nYour task is to assign an overall numeric score from 0.000 to 1.000. You must grade **each referenced item individually** and then average the item scores.\n\n=============================\nSTEP 0 — HARD REQUIREMENT: ORDER & ITEM ID MATCH\n=============================\nFor each referenced item:\n- Extract its order_id and item_id from the reference.\n- The model output MUST contain:\n  • the same order_id (e.g., \"W6876713\" or \"#W6876713\")\n  • the same item_id (exact numeric match, formatting optional)\n\nIf EITHER the order_id or item_id is missing OR does not match:\n→ This item's score = 0.0 and you MUST NOT apply later steps for this item.\n\nMatching descriptive names alone (e.g., \"hiking boots\") is NOT sufficient.\n\n=============================\nSTEP 1 — ELIGIBILITY CHECK (CORRECT OR NOT)\n=============================\nIf the item passed Step 0, evaluate whether the model clearly communicates eligibility:\n\nEligible (True) examples:\n- \"This item is eligible for return.\"\n- \"You can return this item for store credit.\"\n- \"We can process a return or exchange for this item.\"\n\nNot eligible (False) examples:\n- \"This item is not eligible for return.\"\n- \"We cannot accept a return for this item.\"\n- \"This item is outside the return window for electronics.\"\n- \"You must go through the marketplace seller.\"\n\nIf the model:\n- fails to state or imply eligibility, OR\n- states the WRONG eligibility compared to the reference, OR\n- only asks clarifying questions (e.g., \"what is your order ID?\"), OR\n- only asks preference (e.g., \"would you prefer refund or exchange?\") without a decision,\n→ This item's score = 0.0.\n\nIf eligibility is correct, proceed to Step 2.\n\n=============================\nSTEP 2 — POLICY JUSTIFICATION CHECK\n=============================\nA \"policy justification\" means the model connects eligibility to at least one concrete policy detail, such as:\n- Return window / timing (\"within 30 days\", \"outside 15-day electronics window\", \"VIP 45 days\")\n- Category rules (\"defective items are eligible\", \"opened electronics cannot be returned unless defective\", \"replacement only\")\n- Marketplace rules (\"must be returned through marketplace seller\")\n- Account-level refund restrictions (\"store credit only\", \"refund to gift card only\")\n- Any explicit rule explaining WHY eligibility is what it is\n\nIf eligibility is correct BUT the model gives **no meaningful policy justification**, the score MUST be 0.5.\n\nIf eligibility is correct AND the model includes at least one consistent policy justification, the score MUST be 1.0.\n\n=============================\nITEM SCORING SUMMARY\n=============================\nFor each item:\n- Score 0.0 → ID mismatch OR wrong/missing eligibility OR only questions/preference\n- Score 0.5 → IDs correct AND eligibility correct BUT no policy justification\n- Score 1.0 → IDs correct AND eligibility correct AND includes policy justification\n\n=============================\nMULTI-ITEM FINAL SCORE\n=============================\nLet N = number of referenced items.\nLet item_scores = list of per-item scores.\nOverall score = (sum of item_scores) / N.\nClamp to [0,1]. Format with up to three decimal places (e.g., 0.000, 0.500, 0.800, 1.000).\n\n=============================\nSPECIAL CASE\n=============================\nIf ALL items receive 0.0 (no eligibility or all ID mismatches):\n→ Final score MUST be 0.000.\n\n=============================\nOUTPUT FORMAT\n=============================\nOutput ONLY the final numeric score (e.g., \"0.000\", \"0.500\", \"1.000\"). No explanations."
    }
  ],
  "model": "o3-mini",
  "pass_threshold": 0.5
}
